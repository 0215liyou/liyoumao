/*
* @File     : doll.js
* @Author   : jade
* @Date     : 2024/1/4 14:15
* @Email    : jadehh@1ive.com
* @Software : Samples
* @Desc     : doll
*/

import {Spider} from "./spider.js";
import {Crypto, load} from "../lib/cat.js";
import {VodDetail, VodShort} from "../lib/vod.js";
import * as Utils from "../lib/utils.js";

class Doll extends Spider {
    constructor() {
        super();
        this.siteUrl = "https://hongkongdollvideo.com/"
    }

    getAppName() {
        return "üç•‚îÉÁé©ÂÅ∂ÂßêÂßê‚îÉüç•"
    }

    getName() {
        return "Áé©ÂÅ∂ÂßêÂßê"
    }

    async parseVodShortListFromDoc($) {
        let vod_list = []
        let vodElements = $("[class=\"stui-vodlist clearfix\"]").find("li")
        for (const vodElement of vodElements) {
            let resource = $(vodElement).find("[class=\"stui-vodlist__thumb lazyload\"]")[0]
            let vodShort = new VodShort()
            vodShort.vod_id = resource.attribs["href"]
            vodShort.vod_name = resource.attribs["title"]
            vodShort.vod_pic = resource.attribs["data-original"]
            vodShort.vod_remarks = $($(resource).find("[class=\"pic-text text-right\"]")[0]).text()
            vod_list.push(vodShort)
        }
        return vod_list
    }

    async parseVodPlayFromUrl(play_url) {
        let html = await this.fetch(play_url, null, this.getHeader())
        if (html !== null) {
            let $ = load(html)
        }

    }

    async parseVodDetailFromDoc($) {
        let vodDetail = new VodDetail()
        let vodElement = $("[class=\"col-pd clearfix\"]")[1]
        let vodShortElement = $(vodElement).find("[class=\"stui-content__thumb\"]")[0]
        let vodItems = []
        for (const playElement of $("[class=\"stui-content__playlist clearfix\"]").find("a")) {
            let episodeUrl = this.siteUrl + playElement.attribs["href"];
            let episodeName = $(playElement).text();
            vodItems.push(episodeName + "$" + episodeUrl);
        }
        vodDetail.vod_name = $(vodShortElement).find("[class=\"stui-vodlist__thumb picture v-thumb\"]")[0].attribs["title"]
        vodDetail.vod_pic = $(vodShortElement).find("img")[0].attribs["data-original"]
        vodDetail.vod_remarks = $($(vodShortElement).find("[class=\"pic-text text-right\"]")[0]).text()
        let data_str = $($(vodElement).find("[class=\"data\"]")).text().replaceAll("¬†", " ")
        vodDetail.type_name = Utils.getStrByRegex(/Á±ªÂûãÔºö(.*?) /, data_str)
        vodDetail.vod_area = Utils.getStrByRegex(/Âú∞Âå∫Ôºö(.*?) /, data_str)
        vodDetail.vod_year = Utils.getStrByRegex(/Âπ¥‰ªΩÔºö(.*?) /, data_str)
        vodDetail.vod_actor = Utils.getStrByRegex(/‰∏ªÊºîÔºö(.*?) /, data_str)
        vodDetail.vod_director = Utils.getStrByRegex(/ÂØºÊºîÔºö(.*?) /, data_str)
        vodDetail.vod_content = $($("[class=\"stui-pannel_bd\"]").find("[class=\"col-pd\"]")).text()
        vodDetail.vod_play_from = "996"
        vodDetail.vod_play_url = vodItems.join("$$$")
        return vodDetail
    }

    async setClasses() {
        let html = await this.fetch(this.siteUrl, null, this.getHeader())
        if (html !== null) {
            let $ = load(html)
            let navElements = $("[class=\"list-unstyled topnav-menu d-flex d-lg-block align-items-center justify-content-center flex-fill topnav-menu-left m-0\"]").find("li")
            let filterObj = {
                "/acg/y2024/": [
                    {
                        "key": "1",
                        "name": "ÂâßÊÉÖ",
                        "value": [
                            {
                                "n": "ÂÖ®ÈÉ®",
                                "v": "0"
                            },
                            {
                                "n": "ÊêûÁ¨ë",
                                "v": "71"
                            },
                            {
                                "n": "ÁªèÂÖ∏",
                                "v": "72"
                            },
                            {
                                "n": "ÁÉ≠Ë°Ä",
                                "v": "73"
                            },
                            {
                                "n": "ÂÇ¨Ê≥™",
                                "v": "74"
                            },
                            {
                                "n": "Ê≤ªÊÑà",
                                "v": "75"
                            },
                            {
                                "n": "ÁåéÂ•á",
                                "v": "76"
                            },
                            {
                                "n": "Âä±Âøó",
                                "v": "78"
                            },
                            {
                                "n": "ÊàòÊñó",
                                "v": "80"
                            },
                            {
                                "n": "ÂêéÂÆ´",
                                "v": "81"
                            },
                            {
                                "n": "Êú∫Êàò",
                                "v": "82"
                            },
                            {
                                "n": "ÊÅãÁà±",
                                "v": "84"
                            },
                            {
                                "n": "ÁôæÂêà",
                                "v": "85"
                            },
                            {
                                "n": "ÁßëÂπª",
                                "v": "86"
                            },
                            {
                                "n": "Â•áÂπª",
                                "v": "88"
                            },
                            {
                                "n": "Êé®ÁêÜ",
                                "v": "89"
                            },
                            {
                                "n": "Ê†°Âõ≠",
                                "v": "90"
                            },
                            {
                                "n": "ËøêÂä®",
                                "v": "91"
                            },
                            {
                                "n": "È≠îÊ≥ï",
                                "v": "94"
                            },
                            {
                                "n": "ÂéÜÂè≤",
                                "v": "95"
                            },
                            {
                                "n": "‰º™Â®ò",
                                "v": "101"
                            },
                            {
                                "n": "ÁæéÂ∞ëÂ•≥",
                                "v": "102"
                            },
                            {
                                "n": "ËêùËéâ",
                                "v": "103"
                            },
                            {
                                "n": "‰∫≤Â≠ê",
                                "v": "105"
                            },
                            {
                                "n": "ÈùíÊò•",
                                "v": "107"
                            },
                            {
                                "n": "ÂÜíÈô©",
                                "v": "108"
                            },
                            {
                                "n": "Á´ûÊäÄ",
                                "v": "109"
                            }
                        ]
                    },
                    {
                        "key": "2",
                        "name": "Âπ¥‰ª£",
                        "value": [
                            {
                                "n": "ÂÖ®ÈÉ®",
                                "v": "0"
                            },
                            {
                                "n": "2024",
                                "v": "2024"
                            },
                            {
                                "n": "2023",
                                "v": "2023"
                            },
                            {
                                "n": "2022",
                                "v": "2022"
                            },
                            {
                                "n": "2021",
                                "v": "2021"
                            },
                            {
                                "n": "2020",
                                "v": "2020"
                            },
                            {
                                "n": "2019",
                                "v": "2019"
                            },
                            {
                                "n": "2018",
                                "v": "2018"
                            },
                            {
                                "n": "2017",
                                "v": "2017"
                            },
                            {
                                "n": "2016",
                                "v": "2016"
                            },
                            {
                                "n": "2015",
                                "v": "2015"
                            },
                            {
                                "n": "Êõ¥Êó©",
                                "v": "2000"
                            }
                        ]
                    },
                    {
                        "key": "3",
                        "name": "Âú∞Âå∫",
                        "value": [
                            {
                                "n": "ÂÖ®ÈÉ®",
                                "v": "all"
                            },
                            {
                                "n": "Êó•Êú¨",
                                "v": "japan"
                            },
                            {
                                "n": "ÂõΩ‰∫ß",
                                "v": "china"
                            },
                            {
                                "n": "Ëã±ÂõΩ",
                                "v": "england"
                            },
                            {
                                "n": "ÁæéÂõΩ",
                                "v": "american"
                            },
                            {
                                "n": "Èü©ÂõΩ",
                                "v": "korea"
                            }
                        ]
                    }
                ],
                "/tv/y2024/": [
                    {
                        "key": "1",
                        "name": "ÂâßÊÉÖ",
                        "value": [
                            {
                                "n": "ÂÖ®ÈÉ®",
                                "v": "0"
                            },
                            {
                                "n": "Âè§Ë£Ö",
                                "v": "19"
                            },
                            {
                                "n": "Ë®ÄÊÉÖ",
                                "v": "20"
                            },
                            {
                                "n": "Ê≠¶‰æ†",
                                "v": "21"
                            },
                            {
                                "n": "ÂÅ∂ÂÉè",
                                "v": "22"
                            },
                            {
                                "n": "ÂÆ∂Â∫≠",
                                "v": "23"
                            },
                            {
                                "n": "ÈùíÊò•",
                                "v": "24"
                            },
                            {
                                "n": "ÈÉΩÂ∏Ç",
                                "v": "25"
                            },
                            {
                                "n": "Áà±ÊÉÖ",
                                "v": "26"
                            },
                            {
                                "n": "ÂñúÂâß",
                                "v": "27"
                            },
                            {
                                "n": "Êàò‰∫â",
                                "v": "28"
                            },
                            {
                                "n": "ÂÜõÊóÖ",
                                "v": "29"
                            },
                            {
                                "n": "Ë∞çÊàò",
                                "v": "30"
                            },
                            {
                                "n": "ÊÇ¨Áñë",
                                "v": "31"
                            },
                            {
                                "n": "ÁΩ™Ê°à",
                                "v": "32"
                            },
                            {
                                "n": "Á©øË∂ä",
                                "v": "33"
                            },
                            {
                                "n": "ÂÆ´Âª∑",
                                "v": "34"
                            },
                            {
                                "n": "ÂéÜÂè≤",
                                "v": "35"
                            },
                            {
                                "n": "Á•ûËØù",
                                "v": "36"
                            },
                            {
                                "n": "ÁßëÂπª",
                                "v": "37"
                            },
                            {
                                "n": "Âπ¥‰ª£",
                                "v": "38"
                            },
                            {
                                "n": "ÂÜúÊùë",
                                "v": "39"
                            },
                            {
                                "n": "ÂïÜÊàò",
                                "v": "40"
                            },
                            {
                                "n": "ÂâßÊÉÖ",
                                "v": "41"
                            },
                            {
                                "n": "Â•áÂπª",
                                "v": "42"
                            }
                        ]
                    },
                    {
                        "key": "2",
                        "name": "Âπ¥‰ª£",
                        "value": [
                            {
                                "n": "ÂÖ®ÈÉ®",
                                "v": "0"
                            },
                            {
                                "n": "2024",
                                "v": "2024"
                            },
                            {
                                "n": "2023",
                                "v": "2023"
                            },
                            {
                                "n": "2022",
                                "v": "2022"
                            },
                            {
                                "n": "2021",
                                "v": "2021"
                            },
                            {
                                "n": "2020",
                                "v": "2020"
                            },
                            {
                                "n": "2019",
                                "v": "2019"
                            },
                            {
                                "n": "2018",
                                "v": "2018"
                            },
                            {
                                "n": "2017",
                                "v": "2017"
                            },
                            {
                                "n": "2016",
                                "v": "2016"
                            },
                            {
                                "n": "2015",
                                "v": "2015"
                            },
                            {
                                "n": "Êõ¥Êó©",
                                "v": "2000"
                            }
                        ]
                    },
                    {
                        "key": "3",
                        "name": "Âú∞Âå∫",
                        "value": [
                            {
                                "n": "ÂÖ®ÈÉ®",
                                "v": "all"
                            },
                            {
                                "n": "ÂõΩ‰∫ß",
                                "v": "china"
                            },
                            {
                                "n": "Ê∏ØÂâß",
                                "v": "hk"
                            },
                            {
                                "n": "Âè∞Ââß",
                                "v": "tw"
                            },
                            {
                                "n": "ÁæéÂâß",
                                "v": "american"
                            },
                            {
                                "n": "Èü©Ââß",
                                "v": "korea"
                            },
                            {
                                "n": "Ê≥∞Ââß",
                                "v": "thailand"
                            },
                            {
                                "n": "Êó•Ââß",
                                "v": "japan"
                            }
                        ]
                    }
                ],
                "/mov/y2024/": [
                    {
                        "key": "1",
                        "name": "ÂâßÊÉÖ",
                        "value": [
                            {
                                "n": "ÂÖ®ÈÉ®",
                                "v": "0"
                            },
                            {
                                "n": "ÂñúÂâß",
                                "v": "1"
                            },
                            {
                                "n": "ÊÇ≤Ââß",
                                "v": "2"
                            },
                            {
                                "n": "Áà±ÊÉÖ",
                                "v": "3"
                            },
                            {
                                "n": "Âä®‰Ωú",
                                "v": "4"
                            },
                            {
                                "n": "Êû™Êàò",
                                "v": "5"
                            },
                            {
                                "n": "ÁäØÁΩ™",
                                "v": "6"
                            },
                            {
                                "n": "ÊÉäÊÇö",
                                "v": "7"
                            },
                            {
                                "n": "ÊÅêÊÄñ",
                                "v": "8"
                            },
                            {
                                "n": "ÊÇ¨Áñë",
                                "v": "9"
                            },
                            {
                                "n": "Âä®Áîª",
                                "v": "10"
                            },
                            {
                                "n": "ÂÆ∂Â∫≠",
                                "v": "11"
                            },
                            {
                                "n": "Â•áÂπª",
                                "v": "12"
                            },
                            {
                                "n": "È≠îÂπª",
                                "v": "13"
                            },
                            {
                                "n": "ÁßëÂπª",
                                "v": "14"
                            },
                            {
                                "n": "Êàò‰∫â",
                                "v": "15"
                            },
                            {
                                "n": "ÈùíÊò•",
                                "v": "16"
                            },
                            {
                                "n": "ÂâßÊÉÖ",
                                "v": "17"
                            }
                        ]
                    },
                    {
                        "key": "2",
                        "name": "Âπ¥‰ª£",
                        "value": [
                            {
                                "n": "ÂÖ®ÈÉ®",
                                "v": "0"
                            },
                            {
                                "n": "2024",
                                "v": "2024"
                            },
                            {
                                "n": "2023",
                                "v": "2023"
                            },
                            {
                                "n": "2022",
                                "v": "2022"
                            },
                            {
                                "n": "2021",
                                "v": "2021"
                            },
                            {
                                "n": "2020",
                                "v": "2020"
                            },
                            {
                                "n": "2019",
                                "v": "2019"
                            },
                            {
                                "n": "2018",
                                "v": "2018"
                            },
                            {
                                "n": "2017",
                                "v": "2017"
                            },
                            {
                                "n": "2016",
                                "v": "2016"
                            },
                            {
                                "n": "2015",
                                "v": "2015"
                            },
                            {
                                "n": "Êõ¥Êó©",
                                "v": "2000"
                            }
                        ]
                    },
                    {
                        "key": "3",
                        "name": "Âú∞Âå∫",
                        "value": [
                            {
                                "n": "ÂÖ®ÈÉ®",
                                "v": "all"
                            },
                            {
                                "n": "ÂõΩ‰∫ß",
                                "v": "china"
                            },
                            {
                                "n": "È¶ôÊ∏Ø",
                                "v": "hk"
                            },
                            {
                                "n": "Ëã±ÂõΩ",
                                "v": "england"
                            },
                            {
                                "n": "ÁæéÂõΩ",
                                "v": "american"
                            },
                            {
                                "n": "Èü©ÂõΩ",
                                "v": "korea"
                            },
                            {
                                "n": "Ê≥∞ÂõΩ",
                                "v": "thailand"
                            },
                            {
                                "n": "Êó•Êú¨",
                                "v": "japan"
                            }
                        ]
                    }
                ],
                "/zongyi/y2024/": [
                    {
                        "key": "1",
                        "name": "ÂâßÊÉÖ",
                        "value": [
                            {
                                "n": "ÂÖ®ÈÉ®",
                                "v": "0"
                            },
                            {
                                "n": "Êí≠Êä•",
                                "v": "43"
                            },
                            {
                                "n": "ËÆøË∞à",
                                "v": "44"
                            },
                            {
                                "n": "ÊêûÁ¨ë",
                                "v": "45"
                            },
                            {
                                "n": "Ê∏∏Êàè",
                                "v": "46"
                            },
                            {
                                "n": "ÈÄâÁßÄ",
                                "v": "47"
                            },
                            {
                                "n": "Êó∂Â∞ö",
                                "v": "48"
                            },
                            {
                                "n": "ÊÉÖÊÑü",
                                "v": "49"
                            },
                            {
                                "n": "Êôö‰ºö",
                                "v": "50"
                            },
                            {
                                "n": "Êõ≤Ëâ∫",
                                "v": "51"
                            },
                            {
                                "n": "ÁæéÈ£ü",
                                "v": "52"
                            },
                            {
                                "n": "Â∞ëÂÑø",
                                "v": "53"
                            },
                            {
                                "n": "ËÑ±Âè£ÁßÄ",
                                "v": "54"
                            },
                            {
                                "n": "ËÅåÂú∫",
                                "v": "55"
                            },
                            {
                                "n": "Áõ∏‰∫≤",
                                "v": "56"
                            },
                            {
                                "n": "Èü≥‰πê",
                                "v": "57"
                            },
                            {
                                "n": "‰º¶ÁêÜ",
                                "v": "58"
                            },
                            {
                                "n": "Áúü‰∫∫ÁßÄ",
                                "v": "59"
                            },
                            {
                                "n": "ËàûËπà",
                                "v": "60"
                            },
                            {
                                "n": "‰∫≤Â≠ê",
                                "v": "61"
                            },
                            {
                                "n": "Ë¥¢Áªè",
                                "v": "62"
                            },
                            {
                                "n": "ÊóÖÊ∏∏",
                                "v": "63"
                            },
                            {
                                "n": "ÁõäÊô∫",
                                "v": "64"
                            },
                            {
                                "n": "Á´ûÊäÄ",
                                "v": "65"
                            },
                            {
                                "n": "Á∫™ÂÆû",
                                "v": "66"
                            },
                            {
                                "n": "ÁîüÊ¥ª",
                                "v": "67"
                            },
                            {
                                "n": "Áõõ‰ºö",
                                "v": "68"
                            },
                            {
                                "n": "Ê≠åËàû",
                                "v": "69"
                            },
                            {
                                "n": "ÂÖ∂ÂÆÉ",
                                "v": "70"
                            }
                        ]
                    },
                    {
                        "key": "2",
                        "name": "Âπ¥‰ª£",
                        "value": [
                            {
                                "n": "ÂÖ®ÈÉ®",
                                "v": "0"
                            },
                            {
                                "n": "2024",
                                "v": "2024"
                            },
                            {
                                "n": "2023",
                                "v": "2023"
                            },
                            {
                                "n": "2022",
                                "v": "2022"
                            },
                            {
                                "n": "2021",
                                "v": "2021"
                            },
                            {
                                "n": "2020",
                                "v": "2020"
                            },
                            {
                                "n": "2019",
                                "v": "2019"
                            },
                            {
                                "n": "2018",
                                "v": "2018"
                            },
                            {
                                "n": "2017",
                                "v": "2017"
                            },
                            {
                                "n": "2016",
                                "v": "2016"
                            },
                            {
                                "n": "2015",
                                "v": "2015"
                            },
                            {
                                "n": "Êõ¥Êó©",
                                "v": "2000"
                            }
                        ]
                    },
                    {
                        "key": "3",
                        "name": "Âú∞Âå∫",
                        "value": [
                            {
                                "n": "ÂÖ®ÈÉ®",
                                "v": "all"
                            },
                            {
                                "n": "‰∏≠ÂõΩ",
                                "v": "china"
                            },
                            {
                                "n": "Ëã±ÂõΩ",
                                "v": "england"
                            },
                            {
                                "n": "ÁæéÂõΩ",
                                "v": "american"
                            },
                            {
                                "n": "Èü©ÂõΩ",
                                "v": "korea"
                            },
                            {
                                "n": "Ê≥∞ÂõΩ",
                                "v": "thailand"
                            },
                            {
                                "n": "Êó•Êú¨",
                                "v": "japan"
                            }
                        ]
                    }
                ]
            }
            let index = 1
            for (const navElement of navElements) {
                let type_list = $(navElement).text().split("\n")
                let valueElements = $(navElement).find("a")
                let valueList = []
                let type_id = index.toString()
                for (const valueElement of valueElements) {
                    let title = $(valueElement).text().replaceAll("\n","")
                    let href = valueElement.attribs["href"]
                    if (href !== undefined) {
                        valueList.push({"n": title, "v": href})
                    }
                }
                type_list = type_list.filter(element => element !== "");
                let type_dic = {
                    "type_name": type_list[0],
                    "type_id": type_id
                }
                this.filterObj[type_id] = [{"key": "1", "name": type_list[0], "value": valueList}]
                index = index + 1
                this.classes.push(type_dic)

            }

            let menuElements = $("[id=\"side-menu\"]").find("li")
            for (const menuElement of menuElements) {
                let type_id = $(menuElement).find("a")[0].attribs["href"]
                if (type_id !== undefined) {
                    let type_dic = {
                        "type_name": $(menuElement).text(),
                        "type_id": type_id
                    }
                    this.classes.push(type_dic)
                }
            }
        }

    }

    async setHome(filter) {
        await this.setClasses()

    }

    async setCategory(tid, pg, filter, extend) {
        let cateUrl = ""
        if (tid !== "/") {
            cateUrl = this.siteUrl + tid + `/page/${pg.toString()}.html`
        } else {
            cateUrl = this.siteUrl + tid
        }
        this.limit = 36
        let html = await this.fetch(cateUrl, null, this.getHeader())
        if (html != null) {
            let $ = load(html)
            this.vodList = await this.parseVodShortListFromDoc($)
        }
    }

    async setDetail(id) {
        let detailUrl = this.siteUrl + id
        let html = await this.fetch(detailUrl, null, this.getHeader())
        if (html != null) {
            let $ = load(html)
            this.vodDetail = await this.parseVodDetailFromDoc($)
        }
    }

    async setPlay(flag, id, flags) {
        let html = await this.fetch(id, null, this.getHeader())
        if (html !== null) {
            let matcher = Utils.getStrByRegex(/player_aaaa=(.*?)<\/script>/, html)
            let player = JSON.parse(matcher);
            try {
                this.playUrl = decodeURIComponent(Crypto.enc.Utf8.stringify(Crypto.enc.Base64.parse(player["url"])))
            } catch (e) {
                await this.jadeLog.error(e)
            }
        }
    }
}

let spider = new Doll()

async function init(cfg) {
    await spider.init(cfg)
}

async function home(filter) {
    return await spider.home(filter)
}

async function homeVod() {
    return await spider.homeVod()
}

async function category(tid, pg, filter, extend) {
    return await spider.category(tid, pg, filter, extend)
}

async function detail(id) {
    return await spider.detail(id)
}

async function play(flag, id, flags) {
    return await spider.play(flag, id, flags)
}

async function search(wd, quick) {
    return await spider.search(wd, quick)
}

export function __jsEvalReturn() {
    return {
        init: init,
        home: home,
        homeVod: homeVod,
        category: category,
        detail: detail,
        play: play,
        search: search,
    };
}